<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenotazione</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-DQvkBjpPgn7RC31MCQoOeC9TI2kdqa4+BSgNMNj8v77fdC77Kj5zpWFTJaaAoMbC" crossorigin="anonymous">
    <link rel="stylesheet" href="/assets/styles/Navbar.css">
    <link rel="stylesheet" href="/assets/styles/Footer.css">
    <link rel="stylesheet" href="/assets/styles/Prenotazione.css">
</head>
<body>
    <%- include('partials/navbar') %>
    <div id="page">
        <% if (campi.length === 0) { %>
            <div class="alert alert-warning">Nessun campo disponibile al momento.</div>
        <% } else { %>
            <% campi.forEach(campo => { %>
                <%
                let imgSrc = '/images/default-news.jpg';
                if (campo.immagini && campo.immagini.length > 0) {
                    if (campo.immagini[0].url.startsWith('/Sito/Immagini')) {
                        imgSrc = campo.immagini[0].url;
                    } else {
                        imgSrc = '/uploads/' + campo.immagini[0].url.replace(/^\/+/, '');
                    }
                }
                let immaginiHtml = '';
                let numImmagini = (campo.immagini && Array.isArray(campo.immagini)) ? campo.immagini.length : 0;
                if (numImmagini > 0) {
                    immaginiHtml = campo.immagini.map(img => {
                        let src = img.url;
                        if (src.startsWith('/Sito/Immagini')) {
                        } else if (src.startsWith('/uploads')) {
                        } else {
                            src = '/uploads/' + src.replace(/^\/+/, '');
                        }
                        return `<img src="${src}" alt="Campo" class="img-fluid w-100 mb-2 rounded">`;
                    }).join('');
                } else {
                    immaginiHtml = `<img src="/assets/images/default-news.jpg" alt="Campo" class="img-fluid w-100 mb-2 rounded">`;
                }
                %>
                <section class="campo-prenotazione">
                    <div class="container py-5">
                        <div class="row align-items-center">
                            <div class="col-lg-5 col-md-6 mb-4 mb-md-0">
                                <div class="campo-img position-relative overflow-hidden rounded-lg shadow-lg">
                                    <%- immaginiHtml %>
                                    <div class="campo-overlay d-flex align-items-center justify-content-center">
                                        <span class="badge bg-primary px-3 py-2 fs-6"><%= campo.attivo ? 'Disponibile' : 'Non disponibile' %></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-7 col-md-6">
                                <div class="campo-dettagli bg-light p-4 rounded-lg shadow-sm">
                                    <h2 class="campo-tipo fw-bold text-primary mb-3 overflow-hidden"><%= campo.nome || campo.tipo %></h2>
                                    <div class="campo-features mb-4">
                                        <div class="row g-3">
                                            <div class="col-6 col-md-4"><div class="feature-item d-flex align-items-center">
                                                <i class="bi bi-patch-check me-2 text-success"></i>
                                                <span><%= campo.tipo_superficie ? campo.tipo_superficie : 'Erba sintetica' %></span>
                                            </div></div>
                                            <div class="col-6 col-md-4"><div class="feature-item d-flex align-items-center"><i class="bi bi-lightbulb me-2 text-warning"></i><span><%= campo.illuminazione ? 'Illuminazione' : 'No illuminazione' %></span></div></div>
                                            <div class="col-6 col-md-4"><div class="feature-item d-flex align-items-center"><i class="bi bi-droplet me-2 text-info"></i><span><%= campo.docce? 'Docce' : 'No docce' %></span></div></div>
                                            <div class="col-6 col-md-4"><div class="feature-item d-flex align-items-center"><i class="bi bi-door-open me-2 text-secondary"></i><span><%= campo.spogliatoi ? 'Spogliatoi' : 'No spogliatoi' %></span></div></div>
                                            <div class="col-6 col-md-4"><div class="feature-item d-flex align-items-center"><i class="bi bi-p-circle me-2 text-primary"></i><span>Parcheggio</span></div></div>
                                            <div class="col-6 col-md-4"><div class="feature-item d-flex align-items-center"><i class="bi bi-calendar3 me-2 text-danger"></i><span>Disponibilit√†</span></div></div>
                                        </div>
                                    </div>
                                    <p class="campo-descrizione mb-4"><%= campo.descrizione || 'Nessuna descrizione' %></p>
                                    <div class="d-flex flex-column flex-md-row gap-3 mt-4">
                                        <button class="btn btn-primary btn-outline-light rounded-pill px-4 py-2 btn-prenota d-flex align-items-center justify-content-center" data-campo-id="<%= campo.id %>">
                                            <i class="bi bi-calendar-check me-2"></i>
                                            Prenota ora
                                        </button>
                                    </div>
                                    <div class="mt-4 d-flex align-items-center gap-3">
                                        <p class="mb-1"><strong>Orari disponibili per</strong></p>
                                        <form class="d-flex align-items-center ms-3" onsubmit="return false;" data-campo-id="<%= campo.id %>">
                                            <label for="data_orari_<%= campo.id %>" class="visually-hidden">Seleziona data</label>
                                            <input type="date" class="form-control form-control-sm input-orari-campo" id="data_orari_<%= campo.id %>" value="<%= oggi %>" style="width:140px;" data-campo-id="<%= campo.id %>">
                                        </form>
                                    </div>
                                    <div class="d-flex flex-wrap gap-2 mt-2" id="orariDisponibili-<%= campo.id %>">
                                        <% 
                                        const orari = orariDisponibili[campo.id] || [];
                                        const now = new Date();
                                        const filteredOrari = orari.filter(o => {
                                            if (typeof o.prenotato !== 'undefined' && o.prenotato) return false;
                                            const [h, m] = o.inizio.split(":");
                                            const orarioDate = new Date(oggi + 'T' + o.inizio);
                                            if (oggi === now.toISOString().slice(0,10)) {
                                                return (orarioDate.getTime() - now.getTime()) >= 2 * 60 * 60 * 1000;
                                            }
                                            return true;
                                        });
                                        %>
                                        <% filteredOrari.forEach(o => { %>
                                            <span class="badge bg-success text-light border p-2"><%= o.inizio %>-<%= o.fine %></span>
                                        <% }); %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            <% }); %>
        <% } %>
    </div>
    <%- include('partials/footer') %>
    <script type="module">
        import Prenotazione from '/assets/scripts/components/Prenotazione.js';
        
        new Prenotazione(document.getElementById('page'));
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/js/bootstrap.bundle.min.js" integrity="sha384-YUe2LzesAfftltw+PEaao2tjU/QATaW/rOitAq67e0CT0Zi2VVRL0oC4+gAaeBKu" crossorigin="anonymous"></script>
</body>
</html>