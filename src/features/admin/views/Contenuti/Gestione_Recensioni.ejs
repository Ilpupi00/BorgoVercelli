<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Recensioni - Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <%- include('../../shared/views/partials/theme-includes') %>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/css/bootstrap.min.css" rel="stylesheet">
    <%- include('../../shared/views/partials/theme-includes') %>
    <link rel="stylesheet" href="/assets/styles/scroll-animations.css">
    <link rel="stylesheet" href="/assets/styles/Admin.css">
    <link rel="stylesheet" href="/assets/styles/Admin_Global.css">
    <link rel="stylesheet" href="/assets/styles/Admin_Table_Responsive.css">
    <link rel="stylesheet" href="/assets/styles/theme-admin.css">
    <link rel="stylesheet" href="/assets/styles/Gestione_Recensioni.css">
</head>
<body>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <%- include('partials/sidebar.ejs'); %>

            <!-- Contenuto principale -->
            <main class="col-lg-9 col-xl-10 px-4 py-5">
                <div class="admin-container">

                    <!-- Header -->
                    <header class="admin-page-header reveal reveal--fade-up">
                        <div class="admin-page-header-content">
                            <h1><i class="bi bi-star-fill"></i> Gestione Recensioni</h1>
                            <p class="admin-page-subtitle">Modera e gestisci le recensioni degli utenti</p>
                        </div>
                        <div class="admin-page-header-actions">
                            <a href="/admin" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i><span class="d-none d-sm-inline">Pannello</span>
                            </a>
                            <a href="/Logout" class="btn btn-outline-danger">
                                <i class="bi bi-box-arrow-right me-2"></i><span class="d-none d-sm-inline">Esci</span>
                            </a>
                        </div>
                    </header>

                    <!-- Section Header -->
                    <section class="section-header reveal reveal--fade-up reveal--delay-1">
                        <h2 class="section-title mb-0"><i class="bi bi-list-ul me-2"></i>Tutte le Recensioni</h2>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success btn-sm" onclick="mostraRecensioniVisibili()">
                                <i class="bi bi-eye me-1"></i>Visibili
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="mostraRecensioniNascoste()">
                                <i class="bi bi-eye-slash me-1"></i>Nascoste
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="mostraTutteRecensioni()">
                                <i class="bi bi-list me-1"></i>Tutte
                            </button>
                        </div>
                    </section>

                    <!-- Filtri -->
                    <section class="filters-section fade-in">
                        <div class="search-box">
                            <i class="bi bi-search search-icon"></i>
                            <input type="text" class="form-control" id="searchInput" placeholder="Cerca per ID, titolo, contenuto, utente...">
                        </div>
                        <div class="filter-group">
                            <small class="text-muted d-block mb-1">Risultati</small>
                            <div>
                                <span id="totalCount"><%= recensioni ? recensioni.length : 0 %></span> recensioni
                                <span id="filteredCount" class="text-primary">(<%= recensioni ? recensioni.length : 0 %> visualizzate)</span>
                            </div>
                        </div>
                    </section>

                    <!-- Tabella Recensioni -->
                    <section class="admin-content-section fade-in">
                        <div class="admin-table-container">
                            <div class="table-responsive">
                                <table class="admin-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Utente</th>
                                            <th>Valutazione</th>
                                            <th>Titolo</th>
                                            <th>Contenuto</th>
                                            <th>Data</th>
                                            <th class="text-center">Stato</th>
                                            <th class="text-center">Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recensioniTableBody">
                                                <% if (recensioni && recensioni.length > 0) { %>
                                                    <% recensioni.forEach(recensione => { %>
                                                        <tr data-recensione-id="<%= recensione.id %>" 
                                                            data-titolo="<%= (recensione.titolo || '').toLowerCase() %>"
                                                            data-contenuto="<%= (recensione.contenuto || '').toLowerCase() %>"
                                                            data-utente="<%= ((recensione.utente_nome || '') + ' ' + (recensione.utente_cognome || '')).toLowerCase() %>"
                                                            data-valutazione="<%= recensione.valutazione %>"
                                                            data-stato="<%= recensione.visibile ? 'visibile' : 'nascosta' %>">
                                                            <td><%= recensione.id %></td>
                                                            <td>
                                                                <% if (recensione.utente_nome) { %>
                                                                    <%= recensione.utente_nome %> <%= recensione.utente_cognome %>
                                                                <% } else { %>
                                                                    Utente <%= recensione.utente_id %>
                                                                <% } %>
                                                            </td>
                                            <td>
                                                <div class="rating-stars">
                                                    <% for (let i = 1; i <= 5; i++) { %>
                                                        <i class="bi <%= i <= recensione.valutazione ? 'bi-star-fill' : 'bi-star' %>"></i>
                                                    <% } %>
                                                    <span class="ms-2 fw-semibold"><%= recensione.valutazione %>/5</span>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="fw-semibold"><%= recensione.titolo %></div>
                                            </td>
                                            <td>
                                                <span class="review-content" title="<%= recensione.contenuto %>">
                                                    <%= recensione.contenuto.length > 50 ? recensione.contenuto.substring(0, 50) + '...' : recensione.contenuto %>
                                                </span>
                                            </td>
                                            <td><%= recensione.data_recensione ? new Date(recensione.data_recensione).toLocaleDateString('it-IT') : '-' %></td>
                                            <td class="text-center">
                                                <% if (recensione.visibile) { %>
                                                    <span class="badge badge-success"><i class="bi bi-eye me-1"></i>Visibile</span>
                                                <% } else { %>
                                                    <span class="badge badge-secondary"><i class="bi bi-eye-slash me-1"></i>Nascosta</span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="btn btn-sm btn-outline-primary" title="Visualizza" onclick="visualizzaRecensione('<%= recensione.id %>')">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                    <% if (recensione.visibile) { %>
                                                        <button class="btn btn-sm btn-outline-warning" title="Nascondi" onclick="nascondiRecensione('<%= recensione.id %>')">
                                                            <i class="bi bi-eye-slash"></i>
                                                        </button>
                                                    <% } else { %>
                                                        <button class="btn btn-sm btn-outline-success" title="Mostra" onclick="mostraRecensione('<%= recensione.id %>')">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                    <% } %>
                                                    <button class="btn btn-sm btn-outline-danger" title="Elimina" onclick="eliminaRecensione('<%= recensione.id %>')">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    <% }); %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="8" class="text-center py-5">
                                            <div class="empty-state">
                                                <i class="bi bi-star empty-icon"></i>
                                                <p class="empty-text">Nessuna recensione presente nel sistema</p>
                                            </div>
                                        </td>
                                    </tr>
                                <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                </div>
            </main>
        </div>
    </div>

    <!-- Modal Dettagli Recensione -->
    <div class="modal fade" id="visualizzaModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header modal-header-info">
                    <h5 class="modal-title"><i class="bi bi-eye me-2"></i>Dettagli Recensione</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <p><strong>ID:</strong> <span id="modalRecensioneId"></span></p>
                            <p><strong>Utente:</strong> <span id="modalRecensioneUtente"></span></p>
                            <p><strong>Valutazione:</strong> <span id="modalRecensioneValutazione"></span></p>
                            <p><strong>Data:</strong> <span id="modalRecensioneData"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Titolo:</strong> <span id="modalRecensioneTitolo"></span></p>
                            <p><strong>Contenuto:</strong></p>
                            <p id="modalRecensioneContenuto" class="border p-3 rounded bg-light"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>Chiudi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/js/bootstrap.bundle.min.js">
    <%- include('../../shared/views/partials/theme-includes') %></script>
    <script src="/assets/scripts/scroll-reveal.js"></script>
    <script src="/assets/scripts/components/AdminGlobal.js"></script>
    <script src="/assets/scripts/components/Admin.js"></script>
    <script src="/assets/scripts/components/GestioneRecensioni.js"></script>
    <script src="/assets/scripts/components/AdminSidebar.js"></script>
    <script type="module" src="/assets/scripts/utils/showModal.js"></script>

</body>
</html>
