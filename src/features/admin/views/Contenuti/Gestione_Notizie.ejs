<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Notizie - Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Stili globali admin -->
    <link rel="stylesheet" href="/assets/styles/Admin.css">
    <link rel="stylesheet" href="/assets/styles/Admin_Global.css">
    <link rel="stylesheet" href="/assets/styles/Gestione_Notizie.css">
</head>
<body>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <%- include('partials/sidebar.ejs'); %>

            <!-- Contenuto principale -->
            <main class="col-lg-9 col-xl-10 px-4 py-5">
                <div class="admin-container">
                    <!-- Header -->
                    <header class="admin-page-header slide-up">
                        <div class="admin-page-header-content">
                            <h1>
                                <i class="fas fa-newspaper"></i>
                                Gestione Notizie
                            </h1>
                            <p>Crea, modifica e gestisci le notizie del sito</p>
                        </div>
                        <div class="admin-page-header-actions">
                            <a href="/admin" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> <span class="d-none d-sm-inline">Pannello</span>
                            </a>
                            <a href="/Logout" class="btn btn-outline-danger">
                                <i class="bi bi-box-arrow-right"></i> <span class="d-none d-sm-inline">Esci</span>
                            </a>
                        </div>
                    </header>

                    <!-- Action Bar -->
                    <section class="section-header fade-in">
                        <h2 class="section-title mb-0">
                            <i class="bi bi-list-ul"></i>
                            Tutte le Notizie
                        </h2>
                        <a href="/crea-notizie" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Crea Nuova Notizia
                        </a>
                    </section>

                    <!-- Search and Filters -->
                    <section class="filters-section fade-in">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="searchInput"
                                placeholder="Cerca notizie per titolo, autore o contenuto..."
                                aria-label="Cerca notizie"
                            >
                        </div>
                        
                        <div class="filters-row">
                            <div class="filter-group">
                                <label for="statusFilter" class="filter-label">
                                    <i class="fas fa-filter"></i> Stato
                                </label>
                                <select id="statusFilter" class="form-select">
                                    <option value="all">Tutti gli stati</option>
                                    <option value="published">Pubblicate</option>
                                    <option value="draft">Bozze</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="dateFilter" class="filter-label">
                                    <i class="fas fa-calendar"></i> Data
                                </label>
                                <select id="dateFilter" class="form-select">
                                    <option value="all">Tutte le date</option>
                                    <option value="today">Oggi</option>
                                    <option value="week">Questa settimana</option>
                                    <option value="month">Questo mese</option>
                                    <option value="year">Quest'anno</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="sortFilter" class="filter-label">
                                    <i class="fas fa-sort"></i> Ordina per
                                </label>
                                <select id="sortFilter" class="form-select">
                                    <option value="data-desc">Data (più recente)</option>
                                    <option value="data-asc">Data (più vecchia)</option>
                                    <option value="titolo-asc">Titolo (A-Z)</option>
                                    <option value="titolo-desc">Titolo (Z-A)</option>
                                </select>
                            </div>
                        </div>
                    </section>

                    <!-- Statistics Cards -->
                    <section class="row g-3 mb-4 fade-in">
                        <div class="col-md-4">
                            <div class="stats-card">
                                <i class="stats-card-icon fas fa-newspaper"></i>
                                <div class="stats-card-value" id="totalCount">
                                    <%= notizie ? notizie.length : 0 %>
                                </div>
                                <div class="stats-card-label">Totale Notizie</div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="stats-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                <i class="stats-card-icon fas fa-check-circle"></i>
                                <div class="stats-card-value" id="publishedCount">
                                    <%= notizie ? notizie.filter(n => n.pubblicata).length : 0 %>
                                </div>
                                <div class="stats-card-label">Pubblicate</div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="stats-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                <i class="stats-card-icon fas fa-file-alt"></i>
                                <div class="stats-card-value" id="draftCount">
                                    <%= notizie ? notizie.filter(n => !n.pubblicata).length : 0 %>
                                </div>
                                <div class="stats-card-label">Bozze</div>
                            </div>
                        </div>
                    </section>

                    <!-- Notizie List -->
                    <section class="notizie-list fade-in" id="notizieList">
                        <% if (notizie && notizie.length > 0) { %>
                            <% notizie.forEach(notizia => { %>
                                <article class="notizia-card" 
                                    data-notizia-id="<%= notizia.id %>" 
                                    data-stato="<%= notizia.pubblicata ? 'published' : 'draft' %>"
                                    data-titolo="<%= (notizia.titolo || '').toLowerCase() %>"
                                    data-contenuto="<%= (notizia.contenuto || '').toLowerCase() %>"
                                    data-autore="<%= notizia.autore_nome %> <%= notizia.autore_cognome %>"
                                    data-data="<%= notizia.data_pubblicazione ? new Date(notizia.data_pubblicazione).toISOString().split('T')[0] : '' %>">
                                    
                                    <!-- Image -->
                                    <div class="notizia-image-container">
                                        <% if (notizia.immagine && notizia.immagine.url) { %>
                                            <img 
                                                src="<%= notizia.immagine.url %>" 
                                                alt="<%= notizia.titolo %>"
                                                class="notizia-image"
                                                loading="lazy"
                                            >
                                        <% } else { %>
                                            <img 
                                                src="/assets/images/default-news.jpg" 
                                                alt="Immagine placeholder"
                                                class="notizia-image"
                                                loading="lazy"
                                            >
                                        <% } %>
                                        
                                        <!-- Status Badge -->
                                        <span class="notizia-status-badge badge-<%= notizia.pubblicata ? 'pubblicata' : 'bozza' %>">
                                            <% if (notizia.pubblicata) { %>
                                                <i class="fas fa-check"></i> Pubblicata
                                            <% } else { %>
                                                <i class="fas fa-file-alt"></i> Bozza
                                            <% } %>
                                        </span>
                                    </div>
                                    
                                    <!-- Content -->
                                    <div class="notizia-content">
                                        <!-- Meta Information -->
                                        <div class="notizia-meta">
                                            <span class="meta-item">
                                                <i class="fas fa-calendar meta-icon"></i>
                                                <%= notizia.data_pubblicazione ? new Date(notizia.data_pubblicazione).toLocaleDateString('it-IT', { 
                                                    day: '2-digit', 
                                                    month: 'short', 
                                                    year: 'numeric' 
                                                }) : 'Non pubblicata' %>
                                            </span>
                                            <% if (notizia.visualizzazioni) { %>
                                                <span class="meta-item">
                                                    <i class="fas fa-eye meta-icon"></i>
                                                    <%= notizia.visualizzazioni %>
                                                </span>
                                            <% } %>
                                        </div>
                                        
                                        <!-- Title -->
                                        <h2 class="notizia-title"><%= notizia.titolo %></h2>
                                        
                                        <!-- Excerpt -->
                                        <% if (notizia.sottotitolo || notizia.contenuto) { %>
                                            <p class="notizia-excerpt">
                                                <%= notizia.sottotitolo || (notizia.contenuto ? notizia.contenuto.replace(/<[^>]*>/g, '').substring(0, 150) + '...' : '') %>
                                            </p>
                                        <% } %>
                                        
                                        <!-- Footer -->
                                        <div class="notizia-footer">
                                            <div class="notizia-author">
                                                <div class="author-avatar">
                                                    <%= notizia.autore_nome ? notizia.autore_nome.charAt(0).toUpperCase() : 'A' %>
                                                </div>
                                                <span class="author-name">
                                                    <%= notizia.autore_nome || 'Admin' %> <%= notizia.autore_cognome || '' %>
                                                </span>
                                            </div>
                                            
                                            <div class="notizia-actions">
                                                <a 
                                                    href="/notizia/<%= notizia.id %>" 
                                                    class="btn-icon-only btn-view"
                                                    title="Visualizza"
                                                    aria-label="Visualizza notizia"
                                                >
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <button 
                                                    class="btn-icon-only btn-edit"
                                                    onclick="modificaNotizia('<%= notizia.id %>')"
                                                    title="Modifica"
                                                    aria-label="Modifica notizia"
                                                >
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button 
                                                    class="btn-icon-only btn-delete delete-notizia-btn"
                                                    data-notizia-id="<%= notizia.id %>"
                                                    title="Elimina"
                                                    aria-label="Elimina notizia"
                                                >
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </article>
                            <% }) %>
                        <% } else { %>
                            <!-- Empty State -->
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i class="fas fa-newspaper"></i>
                                </div>
                                <h2 class="empty-title">Nessuna notizia trovata</h2>
                                <p class="empty-text">
                                    Non ci sono ancora notizie. Inizia creando la tua prima notizia!
                                </p>
                                <a href="/crea-notizie" class="btn btn-primary">
                                    <i class="fas fa-plus btn-icon"></i>
                                    Crea la tua prima notizia
                                </a>
                            </div>
                        <% } %>
                    </section>
                </div>
            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/scripts/components/AdminGlobal.js"></script>
    <script src="/assets/scripts/components/Admin.js"></script>
    <script src="/assets/scripts/components/GestioneNotizie.js"></script>
    <script type="module" src="/assets/scripts/utils/showModal.js"></script>

</body>
</html>
