<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestore Utenti - Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <%- include('../../shared/views/partials/theme-includes') %>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/css/bootstrap.min.css" rel="stylesheet">
    <%- include('../../shared/views/partials/theme-includes') %>
    <link rel="stylesheet" href="/assets/styles/scroll-animations.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="/assets/styles/Admin.css">
    <link rel="stylesheet" href="/assets/styles/Admin_Global.css">
    <link rel="stylesheet" href="/assets/styles/Admin_Contenuti_Global.css">
    <link rel="stylesheet" href="/assets/styles/Admin_Table_Responsive.css">
    <link rel="stylesheet" href="/assets/styles/Gestore_Utenti.css">
    <link rel="stylesheet" href="/assets/styles/theme-admin.css">
</head>
<body>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <%- include('partials/sidebar.ejs'); %>

            <!-- Contenuto principale -->
            <main class="col-lg-9 col-xl-10 px-4 py-5" role="main">
                <div class="admin-container">

                    <!-- Header con profilo -->
                    <header class="admin-page-header reveal reveal--fade-up">
                        <div class="admin-page-header-content">
                            <h1><i class="bi bi-people-fill"></i> Gestore Utenti</h1>
                            <p class="admin-page-subtitle">Gestisci e monitora tutti gli utenti del sistema</p>
                        </div>
                        <div class="admin-page-header-actions">
                            <a href="<%= user.tipo_utente_id === 1 ? '/admin' : '/profilo' %>" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i><span class="d-none d-sm-inline"><%= user.tipo_utente_id === 1 ? 'Pannello' : 'Profilo' %></span>
                            </a>
                            <a href="/Logout" class="btn btn-outline-danger">
                                <i class="bi bi-box-arrow-right me-2"></i><span class="d-none d-sm-inline">Esci</span>
                            </a>
                        </div>
                    </header>

                    <!-- Contenuto principale -->
                    <article class="content-card reveal reveal--fade-up reveal--delay-1">
                        <div class="section-header">
                            <h2 class="section-title mb-0"><i class="bi bi-list-ul me-2"></i>Tutti gli Utenti</h2>
                        </div>
                        
                        <div class="d-flex justify-content-end align-items-center mb-4">
                            <button class="btn btn-primary" onclick="creaUtente()">
                                <i class="bi bi-person-plus me-2"></i>
                                Crea Nuovo Utente
                            </button>
                        </div>

                            <!-- Barra di ricerca -->
                            <div class="card mb-4 reveal reveal--scale-up reveal--delay-2">
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-8">
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="bi bi-search"></i>
                                                </span>
                                                <input type="text" class="form-control" id="searchInput" placeholder="Cerca per ID, nome, cognome, email...">
                                                <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">
                                                <span id="totalCount"><%= utenti ? utenti.length : 0 %></span> utenti totali
                                                <span id="filteredCount" class="ms-3">(<%= utenti ? utenti.length : 0 %> filtrate)</span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        <!-- Mobile Cards View (nascosta su desktop) -->
                        <div class="admin-mobile-cards reveal reveal--fade-up reveal--delay-3" id="utentiMobileCards">
                            <% if (utenti && utenti.length > 0) { %>
                                <% utenti.forEach(utente => { %>
                                    <div class="admin-mobile-card" 
                                         data-utente-id="<%= utente.id %>" 
                                         data-nome="<%= (utente.nome || '').toLowerCase() %>"
                                         data-cognome="<%= (utente.cognome || '').toLowerCase() %>"
                                         data-email="<%= (utente.email || '').toLowerCase() %>"
                                         data-telefono="<%= (utente.telefono || '').toLowerCase() %>"
                                         data-tipo="<%= utente.tipo_utente_id %>">
                                        
                                        <!-- Header Card -->
                                        <div class="mobile-card-header">
                                            <h3 class="mobile-card-title"><%= utente.nome %> <%= utente.cognome %></h3>
                                            <span class="mobile-card-id">#<%= utente.id %></span>
                                        </div>
                                        
                                        <!-- Body Card -->
                                        <div class="mobile-card-body">
                                            <div class="mobile-info-row">
                                                <span class="mobile-info-label"><i class="bi bi-envelope me-1"></i> Email:</span>
                                                <span class="mobile-info-value"><%= utente.email %></span>
                                            </div>
                                            
                                            <div class="mobile-info-row">
                                                <span class="mobile-info-label"><i class="bi bi-telephone me-1"></i> Telefono:</span>
                                                <span class="mobile-info-value"><%= utente.telefono || '-' %></span>
                                            </div>
                                            
                                            <div class="mobile-info-row">
                                                <span class="mobile-info-label"><i class="bi bi-person-badge me-1"></i> Tipo:</span>
                                                <span class="mobile-info-value">
                                                    <% if (utente.tipo_utente_id === 1) { %>
                                                        <span class="mobile-badge mobile-badge-admin">Admin</span>
                                                    <% } else if (utente.tipo_utente_id === 2) { %>
                                                        <span class="mobile-badge mobile-badge-presidente">Presidente</span>
                                                    <% } else if (utente.tipo_utente_id === 3) { %>
                                                        <span class="mobile-badge mobile-badge-vice">Vice Presidente</span>
                                                    <% } else if (utente.tipo_utente_id === 4) { %>
                                                        <span class="mobile-badge mobile-badge-dirigente">Dirigente</span>
                                                    <% } else if (utente.tipo_utente_id === 5) { %>
                                                        <span class="mobile-badge mobile-badge-segretario">Segretario</span>
                                                    <% } else if (utente.tipo_utente_id === 6) { %>
                                                        <span class="mobile-badge mobile-badge-gestore">Gestore Campo</span>
                                                    <% } else { %>
                                                        <span class="mobile-badge mobile-badge-utente">Utente</span>
                                                    <% } %>
                                                </span>
                                            </div>
                                            
                                            <div class="mobile-info-row">
                                                <span class="mobile-info-label"><i class="bi bi-shield-check me-1"></i> Stato:</span>
                                                <span class="mobile-info-value">
                                                    <% if (utente.stato === 'bannato') { %>
                                                        <span class="mobile-badge mobile-badge-bannato">Bannato</span>
                                                    <% } else if (utente.stato === 'sospeso' && utente.data_fine_sospensione && new Date(utente.data_fine_sospensione) > new Date()) { %>
                                                        <span class="mobile-badge mobile-badge-sospeso">Sospeso</span>
                                                    <% } else { %>
                                                        <span class="mobile-badge mobile-badge-attivo">Attivo</span>
                                                    <% } %>
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <!-- Footer Card con azioni -->
                                        <div class="mobile-card-footer">
                                            <div class="mobile-card-actions">
                                                <button class="mobile-action-btn mobile-btn-info" onclick="visualizzaUtente('<%= utente.id %>')" title="Visualizza">
                                                    <i class="bi bi-eye"></i><span class="d-none d-sm-inline ms-1">Visualizza</span>
                                                </button>
                                                <button class="mobile-action-btn mobile-btn-primary" onclick="modificaUtente('<%= utente.id %>')" title="Modifica">
                                                    <i class="bi bi-pencil"></i><span class="d-none d-sm-inline ms-1">Modifica</span>
                                                </button>
                                                <% if (utente.stato === 'bannato' || (utente.stato === 'sospeso' && utente.data_fine_sospensione && new Date(utente.data_fine_sospensione) > new Date())) { %>
                                                    <button class="mobile-action-btn mobile-btn-success" onclick="revocaSospensioneBan('<%= utente.id %>', '<%= utente.nome %>', '<%= utente.cognome %>')" title="Revoca">
                                                        <i class="bi bi-arrow-clockwise"></i><span class="d-none d-sm-inline ms-1">Revoca</span>
                                                    </button>
                                                <% } else { %>
                                                    <button class="mobile-action-btn mobile-btn-warning" onclick="mostraSospendiBan('<%= utente.id %>', '<%= utente.nome %>', '<%= utente.cognome %>')" title="Sospendi/Banna">
                                                        <i class="bi bi-ban"></i><span class="d-none d-sm-inline ms-1">Sospendi</span>
                                                    </button>
                                                <% } %>
                                                <button class="mobile-action-btn mobile-btn-danger" onclick="eliminaUtente('<%= utente.id %>')" title="Elimina">
                                                    <i class="bi bi-trash"></i><span class="d-none d-sm-inline ms-1">Elimina</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            <% } else { %>
                                <div class="mobile-empty-state">
                                    <i class="bi bi-inbox mobile-empty-icon"></i>
                                    <h5 class="mobile-empty-title">Nessun utente presente</h5>
                                    <p class="mobile-empty-text">Crea il primo utente per iniziare</p>
                                    <button class="btn btn-primary" onclick="creaUtente()">
                                        <i class="bi bi-person-plus me-2"></i>Crea Utente
                                    </button>
                                </div>
                            <% } %>
                        </div>

                        <!-- Desktop Table View (nascosta su mobile) -->
                        <div class="table-responsive reveal reveal--fade-up reveal--delay-3">
                            <table class="table table-hover align-middle" id="utentiTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nome</th>
                                        <th>Cognome</th>
                                        <th>Email</th>
                                        <th>Telefono</th>
                                        <th>Tipo</th>
                                        <th>Stato</th>
                                        <th class="text-center">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="utentiTableBody">
                                                    <% if (utenti && utenti.length > 0) { %>
                                        <% utenti.forEach(utente => { %>
                                            <tr data-utente-id="<%= utente.id %>" 
                                                data-nome="<%= (utente.nome || '').toLowerCase() %>"
                                                data-cognome="<%= (utente.cognome || '').toLowerCase() %>"
                                                data-email="<%= (utente.email || '').toLowerCase() %>"
                                                data-telefono="<%= (utente.telefono || '').toLowerCase() %>"
                                                data-tipo="<%= utente.tipo_utente_id %>">
                                                <td class="truncate-col maxw-120"><%= utente.id %></td>
                                                <td class="truncate-col maxw-140"><%= utente.nome %></td>
                                                <td class="truncate-col maxw-140"><%= utente.cognome %></td>
                                                <td class="truncate-col maxw-220"><%= utente.email %></td>
                                                <td class="truncate-col maxw-120"><%= utente.telefono || '-' %></td>
                                                <td>
                                                    <% if (utente.tipo_utente_id === 1) { %>
                                                        <span class="badge bg-danger">Admin</span>
                                                    <% } else if (utente.tipo_utente_id === 2) { %>
                                                        <span class="badge bg-primary">Presidente</span>
                                                    <% } else if (utente.tipo_utente_id === 3) { %>
                                                        <span class="badge bg-success">Vice Presidente</span>
                                                    <% } else if (utente.tipo_utente_id === 4) { %>
                                                        <span class="badge bg-warning text-dark">Dirigente</span>
                                                    <% } else if (utente.tipo_utente_id === 5) { %>
                                                        <span class="badge bg-secondary">Segretario</span>
                                                    <% } else if (utente.tipo_utente_id === 6) { %>
                                                        <span class="badge bg-info text-dark">Gestore Campo</span>
                                                    <% } else { %>
                                                        <span class="badge bg-info">Utente</span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <% if (utente.stato === 'bannato') { %>
                                                        <span class="badge bg-danger">Bannato</span>
                                                    <% } else if (utente.stato === 'sospeso' && utente.data_fine_sospensione && new Date(utente.data_fine_sospensione) > new Date()) { %>
                                                        <span class="badge bg-warning text-dark">Sospeso</span>
                                                    <% } else { %>
                                                        <span class="badge bg-success">Attivo</span>
                                                    <% } %>
                                                </td>
                                                <td class="text-center">
                                                    <div class="btn-group" role="group">
                                                        <button class="btn btn-sm btn-info" onclick="visualizzaUtente('<%= utente.id %>')" title="Visualizza">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-primary" onclick="modificaUtente('<%= utente.id %>')" title="Modifica">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <% if (utente.stato === 'bannato' || (utente.stato === 'sospeso' && utente.data_fine_sospensione && new Date(utente.data_fine_sospensione) > new Date())) { %>
                                                            <button class="btn btn-sm btn-success" onclick="revocaSospensioneBan('<%= utente.id %>', '<%= utente.nome %>', '<%= utente.cognome %>')" title="Revoca">
                                                                <i class="bi bi-arrow-clockwise"></i>
                                                            </button>
                                                        <% } else { %>
                                                            <button class="btn btn-sm btn-warning" onclick="mostraSospendiBan('<%= utente.id %>', '<%= utente.nome %>', '<%= utente.cognome %>')" title="Sospendi/Banna">
                                                                <i class="bi bi-ban"></i>
                                                            </button>
                                                        <% } %>
                                                        <button class="btn btn-sm btn-danger" onclick="eliminaUtente('<%= utente.id %>')" title="Elimina">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-5">
                                                <i class="bi bi-inbox display-3 d-block mb-3 text-secondary"></i>
                                                <h5>Nessun utente presente</h5>
                                                <p class="mb-3">Crea il primo utente per iniziare</p>
                                                <button class="btn btn-primary" onclick="creaUtente()">
                                                    <i class="bi bi-person-plus me-2"></i>Crea Utente
                                                </button>
                                            </td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3 d-flex flex-column flex-sm-row justify-content-between align-items-center text-muted">
                            <div>
                                <strong>Totale utenti:</strong> <span id="totalCount"><%= utenti ? utenti.length : 0 %></span>
                                <span id="filteredCount">(<%= utenti ? utenti.length : 0 %> filtrate)</span>
                            </div>
                            <div class="d-flex align-items-center mt-2 mt-sm-0">
                                <label class="me-2 mb-0">Mostra</label>
                                <select id="pageSizeSelect" class="form-select form-select-sm me-3" style="width:auto;">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                                <nav aria-label="Paginazione utenti">
                                    <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                                </nav>
                            </div>
                        </div>
                    </article>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Visualizza Utente -->
    <div class="modal fade" id="visualizzaModal" tabindex="-1" aria-labelledby="visualizzaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl" style="max-width: 95%; margin: 1.75rem auto;">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="visualizzaModalLabel"><i class="bi bi-person-circle me-2"></i>Dettagli Utente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="visualizzaContent" style="max-height: 80vh; overflow-y: auto;">
                    <!-- Contenuto caricato dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Crea Utente -->
    <div class="modal fade" id="creaModal" tabindex="-1" aria-labelledby="creaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="creaModalLabel">Crea Nuovo Utente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="creaForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nome" class="form-label">Nome *</label>
                                <input type="text" class="form-control" id="nome" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cognome" class="form-label">Cognome *</label>
                                <input type="text" class="form-control" id="cognome" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="telefono" class="form-label">Telefono</label>
                            <input type="tel" class="form-control" id="telefono">
                        </div>
                        <div class="mb-3">
                            <label for="tipo_utente_id" class="form-label">Tipo Utente</label>
                            <select class="form-select" id="tipo_utente_id">
                                <% if (typeof tipiUtente !== 'undefined' && Array.isArray(tipiUtente) && tipiUtente.length>0) { %>
                                    <% tipiUtente.forEach(function(t) { %>
                                        <option value="<%= t.id %>"><%= t.nome %></option>
                                    <% }); %>
                                <% } else { %>
                                    <!-- Fallback static options (ids: 0=Utente,1=Admin,2=Presidente,3=Vice Presidente,4=Dirigente,5=Segretario,6=Gestore Campo) -->
                                    <option value="0">Utente</option>
                                    <option value="1">Admin</option>
                                    <option value="2">Presidente</option>
                                    <option value="3">Vice Presidente</option>
                                    <option value="4">Dirigente</option>
                                    <option value="5">Segretario</option>
                                    <option value="6">Gestore Campo</option>
                                <% } %>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password *</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" onclick="salvaCrea()">Crea Utente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Modifica Utente -->
    <div class="modal fade" id="modificaModal" tabindex="-1" aria-labelledby="modificaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modificaModalLabel">Modifica Utente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="modificaForm">
                        <input type="hidden" id="modificaId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="modificaNome" class="form-label">Nome *</label>
                                <input type="text" class="form-control" id="modificaNome" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="modificaCognome" class="form-label">Cognome *</label>
                                <input type="text" class="form-control" id="modificaCognome" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="modificaEmail" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="modificaEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="modificaTelefono" class="form-label">Telefono</label>
                            <input type="tel" class="form-control" id="modificaTelefono">
                        </div>
                        <div class="mb-3">
                            <label for="modificaTipo" class="form-label">Tipo Utente</label>
                            <select class="form-select" id="modificaTipo">
                                <% if (typeof tipiUtente !== 'undefined' && Array.isArray(tipiUtente) && tipiUtente.length>0) { %>
                                    <% tipiUtente.forEach(function(t) { %>
                                        <option value="<%= t.id %>"><%= t.nome %></option>
                                    <% }); %>
                                <% } else { %>
                                    <!-- Fallback static options (ids: 0=Utente,1=Admin,2=Presidente,3=Vice Presidente,4=Dirigente,5=Segretario,6=Gestore Campo) -->
                                    <option value="0">Utente</option>
                                    <option value="1">Admin</option>
                                    <option value="2">Presidente</option>
                                    <option value="3">Vice Presidente</option>
                                    <option value="4">Dirigente</option>
                                    <option value="5">Segretario</option>
                                    <option value="6">Gestore Campo</option>
                                <% } %>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" onclick="salvaModifica()">Salva Modifiche</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Sospendi/Banna Scelta -->
    <div class="modal fade" id="sceltaSospendiBanModal" tabindex="-1" aria-labelledby="sceltaSospendiBanLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="sceltaSospendiBanLabel">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Gestione Utente
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <p class="lead mb-4">Cosa vuoi fare con l'utente <strong id="utenteNomeScelta"></strong>?</p>
                    <div class="d-grid gap-3">
                        <button type="button" class="btn btn-warning btn-lg" onclick="mostraSospensione()">
                            <i class="bi bi-clock-history me-2"></i>
                            Sospendi Temporaneamente
                        </button>
                        <button type="button" class="btn btn-danger btn-lg" onclick="mostraBan()">
                            <i class="bi bi-ban me-2"></i>
                            Banna Permanentemente
                        </button>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Sospensione -->
    <div class="modal fade" id="sospensioneModal" tabindex="-1" aria-labelledby="sospensioneModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="sospensioneModalLabel">
                        <i class="bi bi-clock-history me-2"></i>
                        Sospendi Utente
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="sospensioneUtenteId">
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle me-2"></i>
                        Stai per sospendere <strong id="sospensioneUtenteNome"></strong>. L'utente riceverà una email di notifica.
                    </div>
                    <form id="sospensioneForm">
                        <div class="mb-3">
                            <label for="suspensionMotivo" class="form-label">Motivo della sospensione *</label>
                            <textarea class="form-control" id="suspensionMotivo" rows="3" required 
                                placeholder="Es: Violazione delle regole della community..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="suspensionDurata" class="form-label">Durata sospensione (giorni) *</label>
                            <select class="form-select" id="suspensionDurata" required>
                                <option value="">Seleziona durata...</option>
                                <option value="1">1 giorno</option>
                                <option value="3">3 giorni</option>
                                <option value="7">7 giorni (1 settimana)</option>
                                <option value="14">14 giorni (2 settimane)</option>
                                <option value="30">30 giorni (1 mese)</option>
                                <option value="90">90 giorni (3 mesi)</option>
                                <option value="180">180 giorni (6 mesi)</option>
                                <option value="365">365 giorni (1 anno)</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="tornaScelta()">
                        <i class="bi bi-arrow-left me-2"></i>Indietro
                    </button>
                    <button type="button" class="btn btn-warning" onclick="confermaSubmit()">
                        <i class="bi bi-check-circle me-2"></i>Conferma Sospensione
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ban -->
    <div class="modal fade" id="banModal" tabindex="-1" aria-labelledby="banModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="banModalLabel">
                        <i class="bi bi-ban me-2"></i>
                        Banna Utente Permanentemente
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="banUtenteId">
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Attenzione!</strong> Stai per bannare permanentemente <strong id="banUtenteNome"></strong>. 
                        L'utente non potrà più accedere al sito e riceverà una email di notifica.
                    </div>
                    <form id="banForm">
                        <div class="mb-3">
                            <label for="banMotivo" class="form-label">Motivo del ban *</label>
                            <textarea class="form-control" id="banMotivo" rows="4" required 
                                placeholder="Es: Comportamento gravemente scorretto, violazioni ripetute..."></textarea>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            L'utente potrà richiedere lo sblocco contattando l'amministrazione via email.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="tornaScelta()">
                        <i class="bi bi-arrow-left me-2"></i>Indietro
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confermaBan()">
                        <i class="bi bi-ban me-2"></i>Conferma Ban
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Revoca -->
    <div class="modal fade" id="revocaModal" tabindex="-1" aria-labelledby="revocaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="revocaModalLabel">
                        <i class="bi bi-check-circle me-2"></i>
                        Revoca Sospensione/Ban
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <input type="hidden" id="revocaUtenteId">
                    <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                    <p class="lead mt-3">Vuoi riattivare l'account di <strong id="revocaUtenteNome"></strong>?</p>
                    <p class="text-muted">L'utente potrà nuovamente accedere al sito e riceverà una email di notifica.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-success" onclick="confermaRevoca()">
                        <i class="bi bi-check-circle me-2"></i>Conferma Riattivazione
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Notifica -->
    <div class="modal fade" id="notificaModal" tabindex="-1" aria-labelledby="notificaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" id="notificaHeader">
                    <h5 class="modal-title" id="notificaModalLabel">Notifica</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="notificaBody">
                    Messaggio di notifica
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Modifica Prenotazione Admin -->
    <div class="modal fade" id="modificaPrenotazioneModal" tabindex="-1" aria-labelledby="modificaPrenotazioneModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modificaPrenotazioneModalLabel">
                        <i class="bi bi-pencil-square me-2"></i>Modifica Prenotazione (Admin)
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="modificaPrenotazioneForm">
                        <input type="hidden" id="modPrenId">
                        <input type="hidden" id="modPrenUtenteId">
                        
                        <div class="alert alert-info mb-4">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Nota Admin:</strong> Come amministratore, puoi modificare tutti i campi senza cambiare lo stato della prenotazione.
                        </div>
                        
                        <div class="row">
                            <!-- Campo -->
                            <div class="col-md-6 mb-3">
                                <label for="modPrenCampo" class="form-label"><i class="bi bi-geo-alt me-1"></i>Campo *</label>
                                <select class="form-select" id="modPrenCampo" required>
                                    <!-- Caricato dinamicamente -->
                                </select>
                            </div>
                            
                            <!-- Data -->
                            <div class="col-md-6 mb-3">
                                <label for="modPrenData" class="form-label"><i class="bi bi-calendar me-1"></i>Data *</label>
                                <input type="date" class="form-control" id="modPrenData" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Ora Inizio -->
                            <div class="col-md-6 mb-3">
                                <label for="modPrenOraInizio" class="form-label"><i class="bi bi-clock me-1"></i>Ora Inizio *</label>
                                <input type="time" class="form-control" id="modPrenOraInizio" required>
                            </div>
                            
                            <!-- Ora Fine -->
                            <div class="col-md-6 mb-3">
                                <label for="modPrenOraFine" class="form-label"><i class="bi bi-clock-fill me-1"></i>Ora Fine *</label>
                                <input type="time" class="form-control" id="modPrenOraFine" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Telefono -->
                            <div class="col-md-6 mb-3">
                                <label for="modPrenTelefono" class="form-label"><i class="bi bi-telephone me-1"></i>Telefono *</label>
                                <input type="tel" class="form-control" id="modPrenTelefono" 
                                       pattern="^\+39\s?[0-9]{9,10}$" 
                                       placeholder="+39 3xx xxxxxxx (10 cifre dopo +39)" required>
                                <div class="invalid-feedback">
                                    Formato richiesto: +39 seguito da 9-10 cifre (es: +39 3331234567)
                                </div>
                            </div>
                            
                            <!-- Tipo Documento -->
                            <div class="col-md-6 mb-3">
                                <label for="modPrenTipoDoc" class="form-label"><i class="bi bi-card-text me-1"></i>Tipo Documento</label>
                                <select class="form-select" id="modPrenTipoDoc">
                                    <option value="">Nessuno</option>
                                    <option value="CF">Codice Fiscale</option>
                                    <option value="ID">Documento Identità</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Codice Fiscale -->
                            <div class="col-md-6 mb-3" id="modPrenCFContainer" style="display:none;">
                                <label for="modPrenCodiceFiscale" class="form-label"><i class="bi bi-person-vcard me-1"></i>Codice Fiscale</label>
                                <input type="text" class="form-control text-uppercase" id="modPrenCodiceFiscale" 
                                       maxlength="16" pattern="[A-Za-z]{6}[0-9]{2}[A-Za-z][0-9]{2}[A-Za-z][0-9]{3}[A-Za-z]"
                                       placeholder="RSSMRA80A01H501X">
                                <div class="invalid-feedback">
                                    Formato CF non valido (16 caratteri alfanumerici)
                                </div>
                            </div>
                            
                            <!-- Numero Documento -->
                            <div class="col-md-6 mb-3" id="modPrenIDContainer" style="display:none;">
                                <label for="modPrenNumeroDoc" class="form-label"><i class="bi bi-credit-card me-1"></i>Numero Documento</label>
                                <input type="text" class="form-control text-uppercase" id="modPrenNumeroDoc" 
                                       minlength="5" placeholder="AA1234567">
                                <div class="invalid-feedback">
                                    Numero documento deve contenere almeno 5 caratteri
                                </div>
                            </div>
                        </div>
                        
                        <!-- Note -->
                        <div class="mb-3">
                            <label for="modPrenNote" class="form-label"><i class="bi bi-chat-left-text me-1"></i>Note</label>
                            <textarea class="form-control" id="modPrenNote" rows="3" placeholder="Note aggiuntive..."></textarea>
                        </div>
                        
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Attenzione:</strong> L'utente riceverà una notifica della modifica.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Annulla
                    </button>
                    <button type="button" class="btn btn-primary" onclick="GestoreUtente.salvaModificaPrenotazioneAdmin()">
                        <i class="bi bi-check-circle me-1"></i>Salva Modifiche
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="page"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/js/bootstrap.bundle.min.js">
    <%- include('../../shared/views/partials/theme-includes') %></script>
    <script src="/assets/scripts/components/AdminSidebar.js"></script>
    <script type="module" src="/assets/scripts/utils/showModal.js"></script>
    <script src="/assets/scripts/components/Admin.js"></script>
    <script src="/assets/scripts/components/Gestore_utenti.js"></script>
    
    <script>
        // Gestione toggle tipo documento nel modal modifica prenotazione
        document.addEventListener('DOMContentLoaded', function() {
            const tipoDocSelect = document.getElementById('modPrenTipoDoc');
            if (tipoDocSelect) {
                tipoDocSelect.addEventListener('change', function() {
                    const cfContainer = document.getElementById('modPrenCFContainer');
                    const idContainer = document.getElementById('modPrenIDContainer');
                    const cfInput = document.getElementById('modPrenCodiceFiscale');
                    const idInput = document.getElementById('modPrenNumeroDoc');
                    
                    if (this.value === 'CF') {
                        cfContainer.style.display = 'block';
                        idContainer.style.display = 'none';
                        cfInput.required = true;
                        idInput.required = false;
                        idInput.value = '';
                    } else if (this.value === 'ID') {
                        cfContainer.style.display = 'none';
                        idContainer.style.display = 'block';
                        cfInput.required = false;
                        idInput.required = true;
                        cfInput.value = '';
                    } else {
                        cfContainer.style.display = 'none';
                        idContainer.style.display = 'none';
                        cfInput.required = false;
                        idInput.required = false;
                        cfInput.value = '';
                        idInput.value = '';
                    }
                });
            }
            
            // Auto-normalizzazione telefono
            const telefonoInput = document.getElementById('modPrenTelefono');
            if (telefonoInput) {
                telefonoInput.addEventListener('input', function() {
                    let val = this.value.trim();
                    if (val.length > 0 && !val.startsWith('+')) {
                        this.value = '+39' + val.replace(/^0/, '');
                    }
                    this.value = this.value.replace(/[^+0-9\s]/g, '');
                });
                
                telefonoInput.addEventListener('blur', function() {
                    let val = this.value.trim();
                    if (val && !val.startsWith('+39')) {
                        this.value = '+39' + val.replace(/^0/, '');
                    }
                });
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tableBody = document.getElementById('utentiTableBody');
            const mobileContainer = document.getElementById('utentiMobileCards');
            const searchInput = document.getElementById('searchInput');
            const clearSearchBtn = document.getElementById('clearSearch');
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            const paginationEl = document.getElementById('pagination');
            const totalCountEl = document.getElementById('totalCount');

            if (!tableBody) return;

            let rows = Array.from(tableBody.querySelectorAll('tr')).filter(r => r.dataset && r.dataset.utenteId);
            let cards = mobileContainer ? Array.from(mobileContainer.querySelectorAll('.admin-mobile-card')) : [];
            let pageSize = parseInt(pageSizeSelect ? pageSizeSelect.value : 10, 10) || 10;
            let currentPage = 1;
            let visibleIndexes = [];

            function applyFilter() {
                const q = (searchInput && searchInput.value || '').trim().toLowerCase();
                visibleIndexes = [];
                rows.forEach((row, idx) => {
                    let match = true;
                    if (q) {
                        const id = (row.dataset.utenteId||'').toLowerCase();
                        const nome = (row.dataset.nome||'').toLowerCase();
                        const cognome = (row.dataset.cognome||'').toLowerCase();
                        const email = (row.dataset.email||'').toLowerCase();
                        const telefono = (row.dataset.telefono||'').toLowerCase();
                        match = id.includes(q) || nome.includes(q) || cognome.includes(q) || email.includes(q) || telefono.includes(q);
                    }
                    row.style.display = match ? '' : 'none';
                    if (cards.length) {
                        const card = cards[idx];
                        if (card) card.style.display = match ? '' : 'none';
                    }
                    if (match) visibleIndexes.push(idx);
                });
                updateCounts();
                currentPage = 1;
                renderPagination();
                renderPage(currentPage);
            }

            function updateCounts() {
                const total = rows.length;
                const filtered = visibleIndexes.length;
                if (totalCountEl) totalCountEl.textContent = total;
                document.querySelectorAll('#filteredCount').forEach(el => {
                    el.textContent = `(${filtered} filtrate)`;
                });
            }

            function renderPagination() {
                const total = visibleIndexes.length;
                pageSize = parseInt(pageSizeSelect ? pageSizeSelect.value : 10, 10) || 10;
                const totalPages = Math.max(1, Math.ceil(total / pageSize));
                paginationEl.innerHTML = '';
                const makeBtn = (text, disabled, pageNum, active) => {
                    const li = document.createElement('li');
                    li.className = 'page-item' + (disabled ? ' disabled' : '') + (active ? ' active' : '');
                    const a = document.createElement('a');
                    a.className = 'page-link';
                    a.href = '#';
                    a.dataset.page = pageNum;
                    a.textContent = text;
                    a.addEventListener('click', function(e){
                        e.preventDefault();
                        if (!disabled) {
                            currentPage = parseInt(this.dataset.page,10);
                            renderPage(currentPage);
                            const main = document.querySelector('main');
                            if (main) main.scrollIntoView({behavior:'smooth'});
                        }
                    });
                    li.appendChild(a);
                    return li;
                };
                paginationEl.appendChild(makeBtn('«', visibleIndexes.length===0 || currentPage<=1, Math.max(1,currentPage-1)));
                const maxButtons = 10;
                let start = 1, end = totalPages;
                if (totalPages > maxButtons) {
                    start = Math.max(1, currentPage - 4);
                    end = Math.min(totalPages, start + maxButtons -1);
                    if (end - start < maxButtons -1) start = Math.max(1, end - maxButtons +1);
                }
                for (let p=start;p<=end;p++){
                    paginationEl.appendChild(makeBtn(String(p), false, p, p===currentPage));
                }
                paginationEl.appendChild(makeBtn('»', visibleIndexes.length===0 || currentPage>=totalPages, Math.min(totalPages,currentPage+1)));
            }

            function renderPage(page) {
                const total = visibleIndexes.length;
                pageSize = parseInt(pageSizeSelect ? pageSizeSelect.value : 10, 10) || 10;
                const totalPages = Math.max(1, Math.ceil(total / pageSize));
                if (page < 1) page = 1;
                if (page > totalPages) page = totalPages;
                currentPage = page;
                const start = (page-1)*pageSize;
                const end = start + pageSize;
                rows.forEach((row) => row.style.display = 'none');
                cards.forEach(c => c.style.display = 'none');
                for (let i=start;i<end;i++){
                    const idx = visibleIndexes[i];
                    if (typeof idx === 'undefined') continue;
                    const row = rows[idx];
                    if (row) row.style.display = '';
                    const card = cards[idx];
                    if (card) card.style.display = '';
                }
                renderPagination();
                updateCounts();
            }

            // init
            applyFilter();

            // events
            if (searchInput) {
                let timer;
                searchInput.addEventListener('input', function(){
                    clearTimeout(timer);
                    timer = setTimeout(applyFilter, 200);
                });
            }
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', function(){
                    if (searchInput) { searchInput.value = ''; applyFilter(); }
                });
            }
            if (pageSizeSelect) {
                pageSizeSelect.addEventListener('change', function(){
                    pageSize = parseInt(this.value,10) || 10;
                    currentPage = 1;
                    renderPage(currentPage);
                });
                if (rows.length <= 25) pageSizeSelect.value = '25';
            }
        });
    </script>
    <script src="/assets/scripts/scroll-reveal.js"></script>
</body>
</html>
