<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Eventi - Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <%- include('../../shared/views/partials/theme-includes') %>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/css/bootstrap.min.css" rel="stylesheet">
    <%- include('../../shared/views/partials/theme-includes') %>
    <link rel="stylesheet" href="/assets/styles/scroll-animations.css">
    <!-- Stili globali admin -->
    <link rel="stylesheet" href="/assets/styles/Admin.css">
    <link rel="stylesheet" href="/assets/styles/Admin_Global.css">
    <link rel="stylesheet" href="/assets/styles/Admin_Table_Responsive.css">
    <link rel="stylesheet" href="/assets/styles/theme-admin.css">
    <!-- Stili specifici pagina -->
    <link rel="stylesheet" href="/assets/styles/Gestione_Eventi.css">
</head>
<body>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <%- include('partials/sidebar.ejs'); %>

            <!-- Contenuto principale -->
            <main class="col-lg-9 col-xl-10 px-4 py-5">
                <div class="admin-container">

                    <!-- Header -->
                    <header class="admin-page-header reveal reveal--fade-up">
                        <div class="admin-page-header-content">
                            <h1>
                                <i class="bi bi-calendar-event"></i>
                                Gestione Eventi
                            </h1>
                            <p>Organizza e gestisci tutti gli eventi del sito</p>
                        </div>
                        <div class="admin-page-header-actions">
                            <a href="<%= user.tipo_utente_id === 1 ? '/admin' : '/profilo' %>" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> <span class="d-none d-sm-inline"><%= user.tipo_utente_id === 1 ? 'Pannello' : 'Profilo' %></span>
                            </a>
                            <a href="/Logout" class="btn btn-outline-danger">
                                <i class="bi bi-box-arrow-right"></i> <span class="d-none d-sm-inline">Esci</span>
                            </a>
                        </div>
                    </header>

                    <!-- Section Header -->
                    <section class="section-header reveal reveal--fade-up reveal--delay-1">
                        <h2 class="section-title mb-0">
                            <i class="bi bi-list-ul"></i>
                            Tutti gli Eventi
                        </h2>
                        <a href="/evento/crea-evento" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i>
                            Crea Nuovo Evento
                        </a>
                    </section>

                    <!-- Barra di ricerca e filtri -->
                    <section class="filters-section fade-in">
                        <div class="search-box">
                            <i class="bi bi-search search-icon"></i>
                            <input type="text" class="form-control" id="searchInput" placeholder="Cerca per ID, titolo, descrizione, luogo...">
                        </div>
                        
                        <div class="filters-row">
                            <div class="filter-group">
                                <label for="statusFilter" class="filter-label">
                                    <i class="bi bi-filter"></i> Stato
                                </label>
                                <select class="form-select" id="statusFilter">
                                    <option value="all">Tutti gli stati</option>
                                    <option value="published">Pubblicati</option>
                                    <option value="draft">Bozze</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label for="typeFilter" class="filter-label">
                                    <i class="bi bi-tag"></i> Tipo
                                </label>
                                <select class="form-select" id="typeFilter">
                                    <option value="all">Tutti i tipi</option>
                                    <option value="Torneo">Torneo</option>
                                    <option value="Partita">Partita</option>
                                    <option value="Allenamento">Allenamento</option>
                                    <option value="Evento Sociale">Evento Sociale</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label for="dateFilter" class="filter-label">
                                    <i class="bi bi-calendar"></i> Data
                                </label>
                                <select class="form-select" id="dateFilter">
                                    <option value="all">Tutte le date</option>
                                    <option value="upcoming">Futuri</option>
                                    <option value="past">Passati</option>
                                    <option value="today">Oggi</option>
                                    <option value="week">Questa settimana</option>
                                    <option value="month">Questo mese</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <small class="text-muted d-block mb-1">Risultati</small>
                                <div>
                                    <span id="totalCount"><%= eventi ? eventi.length : 0 %></span> eventi
                                    <span id="filteredCount" class="text-primary">(<%= eventi ? eventi.length : 0 %> visualizzati)</span>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Eventi Table -->
                    <section class="admin-content-section fade-in">
                        <div class="admin-table-container">
                            
                            <!-- Mobile Cards View (nascosta su desktop) -->
                            <div class="admin-mobile-cards" id="eventiMobileCards">
                                <% if (eventi && eventi.length > 0) { %>
                                    <% eventi.forEach(evento => { %>
                                        <div class="admin-mobile-card" 
                                             data-evento-id="<%= evento.id %>" 
                                             data-titolo="<%= evento.titolo.toLowerCase() %>"
                                             data-descrizione="<%= (evento.descrizione || '').toLowerCase() %>"
                                             data-stato="<%= evento.pubblicato ? 'published' : 'draft' %>"
                                             data-data-inizio="<%= evento.data_inizio || '' %>"
                                             data-data-fine="<%= evento.data_fine || '' %>"
                                             data-luogo="<%= (evento.luogo || '').toLowerCase() %>"
                                             data-tipo="<%= evento.tipo_evento || '' %>">
                                            
                                            <!-- Header Card -->
                                            <div class="mobile-card-header">
                                                <h3 class="mobile-card-title"><%= evento.titolo %></h3>
                                                <span class="mobile-card-id">#<%= evento.id %></span>
                                            </div>
                                            
                                            <!-- Body Card -->
                                            <div class="mobile-card-body">
                                                <% if (evento.descrizione) { %>
                                                    <div class="mobile-info-row">
                                                        <span class="mobile-info-label"><i class="bi bi-file-text me-1"></i> Descrizione:</span>
                                                        <span class="mobile-info-value truncate-text-2"><%= (evento.descrizione || '').replace(/<[^>]*>/g, '').substring(0, 100) %>...</span>
                                                    </div>
                                                <% } %>
                                                
                                                <div class="mobile-info-row">
                                                    <span class="mobile-info-label"><i class="bi bi-calendar-check me-1"></i> Data Inizio:</span>
                                                    <span class="mobile-info-value"><%= evento.data_inizio ? new Date(evento.data_inizio).toLocaleDateString('it-IT') : 'N/A' %></span>
                                                </div>
                                                
                                                <div class="mobile-info-row">
                                                    <span class="mobile-info-label"><i class="bi bi-calendar-x me-1"></i> Data Fine:</span>
                                                    <span class="mobile-info-value"><%= evento.data_fine ? new Date(evento.data_fine).toLocaleDateString('it-IT') : 'N/A' %></span>
                                                </div>
                                                
                                                <div class="mobile-info-row">
                                                    <span class="mobile-info-label"><i class="bi bi-geo-alt me-1"></i> Luogo:</span>
                                                    <span class="mobile-info-value"><%= evento.luogo || 'N/A' %></span>
                                                </div>
                                                
                                                <div class="mobile-info-row">
                                                    <span class="mobile-info-label"><i class="bi bi-tag me-1"></i> Tipo:</span>
                                                    <span class="mobile-info-value">
                                                        <span class="mobile-badge mobile-badge-utente"><%= evento.tipo_evento || 'N/A' %></span>
                                                    </span>
                                                </div>
                                                
                                                <div class="mobile-info-row">
                                                    <span class="mobile-info-label"><i class="bi bi-eye me-1"></i> Stato:</span>
                                                    <span class="mobile-info-value">
                                                        <% if (evento.pubblicato) { %>
                                                            <span class="mobile-badge mobile-badge-pubblicato">
                                                                <i class="bi bi-check-circle me-1"></i>Pubblicato
                                                            </span>
                                                        <% } else { %>
                                                            <span class="mobile-badge mobile-badge-bozza">
                                                                <i class="bi bi-pencil me-1"></i>Bozza
                                                            </span>
                                                        <% } %>
                                                    </span>
                                                </div>
                                                
                                                <div class="mobile-info-row">
                                                    <span class="mobile-info-label"><i class="bi bi-people me-1"></i> Max Partecipanti:</span>
                                                    <span class="mobile-info-value"><%= evento.max_partecipanti || '∞' %></span>
                                                </div>
                                            </div>
                                            
                                            <!-- Footer Card con azioni -->
                                            <div class="mobile-card-footer">
                                                <div class="mobile-card-actions">
                                                    <a href="/evento/<%= evento.id %>" class="mobile-action-btn mobile-btn-info" title="Visualizza" target="_blank">
                                                        <i class="bi bi-eye"></i><span class="d-none d-sm-inline ms-1">Visualizza</span>
                                                    </a>
                                                    <button class="mobile-action-btn mobile-btn-warning btn-modifica-evento" title="Modifica" data-evento-id="<%= evento.id %>">
                                                        <i class="bi bi-pencil"></i><span class="d-none d-sm-inline ms-1">Modifica</span>
                                                    </button>
                                                    <button class="mobile-action-btn mobile-btn-<%= evento.pubblicato ? 'secondary' : 'success' %> toggle-pubblicazione" 
                                                            title="<%= evento.pubblicato ? 'Ritira' : 'Pubblica' %>" 
                                                            data-evento-id="<%= evento.id %>" 
                                                            data-current-status="<%= evento.pubblicato ? 1 : 0 %>">
                                                        <i class="bi <%= evento.pubblicato ? 'bi-eye-slash' : 'bi-eye' %>"></i>
                                                        <span class="d-none d-sm-inline ms-1"><%= evento.pubblicato ? 'Ritira' : 'Pubblica' %></span>
                                                    </button>
                                                    <button class="mobile-action-btn mobile-btn-danger btn-elimina-evento" title="Elimina" data-evento-id="<%= evento.id %>">
                                                        <i class="bi bi-trash"></i><span class="d-none d-sm-inline ms-1">Elimina</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    <% }); %>
                                <% } else { %>
                                    <div class="mobile-empty-state">
                                        <i class="bi bi-calendar-x mobile-empty-icon"></i>
                                        <h5 class="mobile-empty-title">Nessun evento presente</h5>
                                        <p class="mobile-empty-text">Nessun evento presente nel sistema</p>
                                        <a href="/evento/crea-evento" class="btn btn-primary">
                                            <i class="bi bi-plus-circle me-2"></i>Crea il primo evento
                                        </a>
                                    </div>
                                <% } %>
                            </div>

                            <!-- Desktop Table View (nascosta su mobile) -->
                            <div class="table-responsive">
                                <table class="admin-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Titolo</th>
                                            <th>Data Inizio</th>
                                            <th>Data Fine</th>
                                            <th>Luogo</th>
                                            <th>Tipo</th>
                                            <th>Stato</th>
                                            <th>Partecipanti Max</th>
                                            <th class="text-center">Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody id="eventiTableBody">
                                                <% if (eventi && eventi.length > 0) { %>
                                                    <% eventi.forEach(evento => { %>
                                                        <tr data-evento-id="<%= evento.id %>" 
                                                            data-titolo="<%= evento.titolo.toLowerCase() %>"
                                                            data-descrizione="<%= (evento.descrizione || '').toLowerCase() %>"
                                                            data-stato="<%= evento.pubblicato ? 'published' : 'draft' %>"
                                                            data-data-inizio="<%= evento.data_inizio || '' %>"
                                                            data-data-fine="<%= evento.data_fine || '' %>"
                                                            data-luogo="<%= (evento.luogo || '').toLowerCase() %>"
                                                            data-tipo="<%= evento.tipo_evento || '' %>">
                                                            <td><%= evento.id %></td>
                                                            <td>
                                                                <div class="fw-semibold"><%= evento.titolo %></div>
                                                                <% if (evento.descrizione) { %>
                                                                    <small class="text-muted"><%= (evento.descrizione || '').replace(/<[^>]*>/g, '').substring(0, 50) %>...</small>
                                                                <% } %>
                                                            </td>
                                                            <td><%= evento.data_inizio ? new Date(evento.data_inizio).toLocaleDateString('it-IT') : 'N/A' %></td>
                                                            <td><%= evento.data_fine ? new Date(evento.data_fine).toLocaleDateString('it-IT') : 'N/A' %></td>
                                                            <td><%= evento.luogo || 'N/A' %></td>
                                                            <td>
                                                                <span class="badge badge-info">
                                                                    <%= evento.tipo_evento || 'N/A' %>
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <% if (evento.pubblicato) { %>
                                                                    <span class="badge badge-success">
                                                                        <i class="bi bi-check-circle me-1"></i>Pubblicato
                                                                    </span>
                                                                <% } else { %>
                                                                    <span class="badge badge-warning">
                                                                        <i class="bi bi-pencil me-1"></i>Bozza
                                                                    </span>
                                                                <% } %>
                                                            </td>
                                                            <td class="text-center"><%= evento.max_partecipanti || '∞' %></td>
                                                            <td>
                                                                <div class="action-buttons">
                                                                    <a href="/evento/<%= evento.id %>" class="btn btn-sm btn-outline-primary" title="Visualizza" target="_blank">
                                                                        <i class="bi bi-eye"></i>
                                                                    </a>
                                                                    <button class="btn btn-sm btn-outline-warning btn-modifica-evento" title="Modifica" data-evento-id="<%= evento.id %>">
                                                                        <i class="bi bi-pencil"></i>
                                                                    </button>
                                                                    <button class="btn btn-sm btn-outline-<%= evento.pubblicato ? 'secondary' : 'success' %> toggle-pubblicazione" 
                                                                            title="<%= evento.pubblicato ? 'Ritira' : 'Pubblica' %>" 
                                                                            data-evento-id="<%= evento.id %>" 
                                                                            data-current-status="<%= evento.pubblicato ? 1 : 0 %>">
                                                                        <i class="bi <%= evento.pubblicato ? 'bi-eye-slash' : 'bi-eye' %>"></i>
                                                                    </button>
                                                                    <button class="btn btn-sm btn-outline-danger btn-elimina-evento" title="Elimina" data-evento-id="<%= evento.id %>">
                                                                        <i class="bi bi-trash"></i>
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    <% }); %>
                                                    <!-- Riga per nessun risultato dai filtri -->
                                                    <tr id="noResultsRow" class="d-none">
                                                        <td colspan="9" class="text-center py-5">
                                                            <div class="empty-state">
                                                                <i class="bi bi-search empty-icon"></i>
                                                                <p class="empty-text">Nessun evento corrisponde ai filtri selezionati</p>
                                                                <button class="btn btn-outline-secondary" onclick="gestioneEventi.clearAllFilters()">
                                                                    <i class="bi bi-x-circle me-1"></i> Rimuovi filtri
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                <% } else { %>
                                                    <tr id="noDataRow">
                                                        <td colspan="9" class="text-center py-5">
                                                            <div class="empty-state">
                                                                <i class="bi bi-calendar-x empty-icon"></i>
                                                                <p class="empty-text">Nessun evento presente nel sistema</p>
                                                                <a href="/evento/crea-evento" class="btn btn-primary">
                                                                    <i class="bi bi-plus-circle me-1"></i> Crea il primo evento
                                                                </a>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                </main>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/js/bootstrap.bundle.min.js">
    <%- include('../../shared/views/partials/theme-includes') %></script>
    <script src="/assets/scripts/scroll-reveal.js"></script>
    <script src="/assets/scripts/components/AdminGlobal.js"></script>
    <script src="/assets/scripts/components/Admin.js"></script>
    
    <!-- Page-specific JS -->
    <script src="/assets/scripts/components/GestioneEventi.js"></script>
    
    <!-- Modal Helper -->
    <script type="module" src="/assets/scripts/utils/showModal.js"></script>

</body>
</html>
